<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font -->
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-700.woff2" type="font/woff2" crossorigin>

  <!-- script -->
  <script src="/ego/js/darkmode-init.js"></script>
  <!-- stylesheet -->
  <link rel="stylesheet" href="/ego/css/main.css" crossorigin="anonymous">
  <noscript><style>img.lazyload { display: none; }</style></noscript>

  <!-- seo -->
 

  <!-- Favicon -->
  <meta name="theme-color" content="">
  <link rel="apple-touch-icon" sizes="180x180" href="/ego/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/ego/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ego/favicon-16x16.png">
  <link rel="manifest" crossorigin="use-credentials" href="/ego/site.webmanifest">

</head>


  <body class="blog list">
     <div class="header-bar"></div>

<header class="navbar navbar-expand-md navbar-light doks-navbar">
  <nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation">
    <a class="navbar-brand p-0 me-auto" href="/" aria-label="Ego">
      Ego
    </a>

    <button class="btn btn-menu d-block d-md-none order-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDoks" aria-controls="offcanvasDoks" aria-label="Open main menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="offcanvas offcanvas-start border-0 py-md-1" tabindex="-1" id="offcanvasDoks" data-bs-backdrop="true" aria-labelledby="offcanvasDoksLabel">
      <div class="header-bar d-md-none"></div>
      <div class="offcanvas-header d-md-none">
        <h2 class="h5 offcanvas-title ps-2" id="offcanvasDoksLabel"><a class="text-dark" href="/">Ego</a></h2>
        <button type="button" class="btn-close text-reset me-2" data-bs-dismiss="offcanvas" aria-label="Close main menu"></button>
      </div>
      <div class="offcanvas-body px-4">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3>
        <ul class="nav flex-column flex-md-row ms-md-n3">
          
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/docs/prologue/introduction">Docs</a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/blog">Blog</a>
            </li>
          </ul>
        <hr class="text-black-50 my-4 d-md-none">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3>
        <ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2">
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://github.com/h-enk/doks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><small class="ms-2 d-md-none">GitHub</small></a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://twitter.com/getdoks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><small class="ms-2 d-md-none">Twitter</small></a>
            </li>
          </ul>
      </div>
    </div>

    <button id="mode" class="btn btn-link order-md-1" type="button" aria-label="Toggle user interface mode">
      <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
      <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
    </button>
    </nav>
</header>


    <div class="wrap container-xxl" role="document">
      <div class="content">
        
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-10 col-xl-8">
    <article>
      <div class="blog-header">
        <h1>Chuẩn hoá và validate dữ liệu trong Phoenix với thư viện Tarams</h1>
        <p><small>Posted 2020-10-01 by
  <a class="stretched-link position-relative" href="/contributors/dung-nguyen/">Dung Nguyen</a>
  
  </strong></small><p>

      </div>
      <p class="lead"></p>
      <p>**Version mới của thư viện <code class="inline">Tarams</code> không tương thích với bản cũ. Các bạn đọc bài mới ở đây nhé <a href="/blog/2021-08-14-validate-request-params-with-phoenix">How to validate request params in Phoenix</a></p><p>Yêu cầu chuẩn hoá và validate các tham số truyền lên từ client là yêu cầu cơ bản khi xây dựng API Web. Mình đã có một bài hướng dẫn sử dụng Ecto.Changeset để chuẩn hoá trong bài viết này:</p><p><a href="https://dev.to/bluzky/parse-va-validate-request-param-trong-phoenix-v-i-ecto-151a">Parse và validate request param trong Phoenix với Ecto </a></p><p>Trong bài viết này, mình sẽ hướng dẫn một cách ngắn và đơn giản hơn bằng cách sử dụng thư viện sẵn có <a href="https://github.com/bluzky/tarams/">Tarams</a>. Thư viện này thực ra là sử dụng lại <code class="inline">Ecto.Changeset</code> nhưng nó giúp cho chúng ta không phải lặp lại quá nhiều code như khi dùng <code class="inline">Ecto.Changeset</code></p><p>Một vài tính năng thú vị của Tarams:</p><ul><li>Cung cấp cách thức đơn giản để định nghĩa các cấu trúc tham số</li><li>Cho phép định nghĩa các giá trị default động</li><li>Cho phép định nghĩa các hàm để cast giá trị về đúng kiểu dữ liệu</li><li>Định nghĩa hàm để validate dữ liệu</li></ul><p>Sau đây là cách sử dụng <code class="inline">Tarams</code>. Ví dụ chúng ta đang viết API để cập nhật profile của nhân viên. Yêu cầu là</p><pre><code>email: bắt buộc, đúng định dạng
first_name: bắt buộc
last_name: bắt buộc
birthday: không bắt buộc, kiểu ngày tháng
title: không bắt buộc
start_date: ngày bắt đầu làm việc, ngày tháng, mặc định là ngày hiện tại</code></pre><h2 id="1-dinh-nghia-cau-truc-cua-tham-so-truyen-len-kha-d">1. Định nghĩa cấu trúc của tham số truyền lên khá đơn giản</h2><pre><code class="elixir">@schema  %{
    email: [type: :string],
    first_name: [type: :string],
    last_name: [type: :string],
    title: :string,
    birth_day: [type: :date],
    start_date: [type: :date]
}</code></pre><p>Schema đơn giản chỉ là một map với key là tên field và value là 1 list option của field đó.</p><h2 id="2-bay-gio-them-cac-rang-buoc">2. Bây giờ thêm các ràng buộc</h2><ul><li>Để đánh dấu 1 trường là bắt buộc, thêm option <code class="inline">required: true</code></li><li><code class="inline">Taram</code> cũng cho phép validate data sử dụng lại các hàm validate của <code class="inline">Changeset</code></li></ul><pre><code class="elixir">@schema  %{
    email: [type: :string, required: true, validate: {:format, ~r/@/}],
    first_name: [type: :string, required: true],
    last_name: [type: :string, required: true],
    title: :string,
    birth_day: [type: :date],
    start_date: [type: :date]
}</code></pre><h2 id="3-bay-gio-thi-set-cac-gia-tri-default">3. Bây giờ thì set các giá trị default</h2><p><code class="inline">default</code> có thể là 1 giá trị hoặc 1 hàm. Mỗi khi parse tham số thì hàm này sẽ được gọi để lấy giá trị mặc định</p><pre><code class="elixir">@schema  %{
    ...
    title: [type: :string, default: "staff"],
    birth_day: [type: :date],
    start_date: [type: :date, default: &Timex.today/0]
}</code></pre><h2 id="4-cast-cac-gia-tri-tham-so-ve-dung-kieu">4. Cast các giá trị tham số về đúng kiểu</h2><p>Nhiều các giá trị tham số truyền lên phải được chuyển về đúng các loại dữ liệu phức tạp như ngày tháng, list.
Ví dụ ngày tháng truyền lên là string <code class="inline">01/12/1994</code> thì phải chuyển về kiểu date để sử dụng lại được. Tarams hỗ trợ định nghĩa 1 hàm custom để cast giá trị, hàm này trả về </p><ul><li><code class="inline">{:ok, value}</code> nếu parse thành công</li><li><code class="inline">{:error, error_message}</code> nếu thất bại</li></ul><pre><code class="elixir">def parse_date(date_str) do
    Timex.parse(date_str, "{0D}/{0M}/{YYYY}")
end

@schema  %{
    ...
    title: [type: :string, default: "staff"],
    birth_day: [type: :date, cast_func: &parse_date/1],
    start_date: [type: :date, default: &Timex.today/0]
}</code></pre><h2 id="5-bay-gio-su-dung-nao">5. Bây giờ sử dụng nào</h2><pre><code class="elixir">def update(conn, params) do
    with {:ok, user_data} <- Tarams.parse(@schema, params) do
        # do anything with your params
        # access data bằng atom key: user_data.email
    else
        {:error, changset} -> # return params error
    end
end</code></pre><p>Hàm <code class="inline">parse</code> sẽ parse và validate dữ liệu. Nếu mọi thứ đều ổn, sẽ trả về <code class="inline">{:ok, data}</code> và ngược lại thì trả về <code class="inline">{:error, changeset}</code>.</p><p>Done! Code của bạn sẽ trở nên đơn giản và ngắn gọn hơn nhiều</p>
    </article>
  </div>
</div>

      </div>
    </div>
    <footer class="footer text-muted">
  <div class="container-xxl">
    <div class="row">
      <div class="col-lg-8 order-last order-lg-first">
        <ul class="list-inline">
          <li class="list-inline-item">Powered by <a href="https://github.com/bluzky/ego/">Ego</a></li>
        </ul>
      </div>
      <div class="col-lg-8 order-first order-lg-last text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item"><a href="/ego/about">About me</a></li>
          <li class="list-inline-item"><a href="/ego/author">Authors</a></li>
          </ul>
      </div>
    </div>
  </div>
</footer>

    <script src="/ego/js/jquery.min.js" defer></script>
<script src="/ego/js/bootstrap.min.js" defer></script>
<script src="/ego/js/highlight.js" defer></script>
<script src="/ego/js/darkmode.js" defer></script>
<script src="/ego/js/alert.js" defer></script>
<script src="/ego/js/index.js" defer></script>

  </body>
</html>
