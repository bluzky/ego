<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font -->
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-700.woff2" type="font/woff2" crossorigin>

  <!-- script -->
  <script src="/ego/js/darkmode-init.js"></script>
  <!-- stylesheet -->
  <link rel="stylesheet" href="/ego/css/main.css" crossorigin="anonymous">
  <noscript><style>img.lazyload { display: none; }</style></noscript>

  <!-- seo -->
 

  <!-- Favicon -->
  <meta name="theme-color" content="">
  <link rel="apple-touch-icon" sizes="180x180" href="/ego/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/ego/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ego/favicon-16x16.png">
  <link rel="manifest" crossorigin="use-credentials" href="/ego/site.webmanifest">

</head>


  <body class="blog list">
     <div class="header-bar"></div>

<header class="navbar navbar-expand-md navbar-light doks-navbar">
  <nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation">
    <a class="navbar-brand p-0 me-auto" href="/" aria-label="Ego">
      Ego
    </a>

    <button class="btn btn-menu d-block d-md-none order-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDoks" aria-controls="offcanvasDoks" aria-label="Open main menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="offcanvas offcanvas-start border-0 py-md-1" tabindex="-1" id="offcanvasDoks" data-bs-backdrop="true" aria-labelledby="offcanvasDoksLabel">
      <div class="header-bar d-md-none"></div>
      <div class="offcanvas-header d-md-none">
        <h2 class="h5 offcanvas-title ps-2" id="offcanvasDoksLabel"><a class="text-dark" href="/">Ego</a></h2>
        <button type="button" class="btn-close text-reset me-2" data-bs-dismiss="offcanvas" aria-label="Close main menu"></button>
      </div>
      <div class="offcanvas-body px-4">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3>
        <ul class="nav flex-column flex-md-row ms-md-n3">
          
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/docs/prologue/introduction">Docs</a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/blog">Blog</a>
            </li>
          </ul>
        <hr class="text-black-50 my-4 d-md-none">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3>
        <ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2">
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://github.com/h-enk/doks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><small class="ms-2 d-md-none">GitHub</small></a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://twitter.com/getdoks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><small class="ms-2 d-md-none">Twitter</small></a>
            </li>
          </ul>
      </div>
    </div>

    <button id="mode" class="btn btn-link order-md-1" type="button" aria-label="Toggle user interface mode">
      <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
      <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
    </button>
    </nav>
</header>


    <div class="wrap container-xxl" role="document">
      <div class="content">
        
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-10 col-xl-8">
    <article>
      <div class="blog-header">
        <h1>Parse và validate request param trong Phoenix với Ecto</h1>
        <p><small>Posted 2020-09-26 by
  <a class="stretched-link position-relative" href="/contributors/dung-nguyen/">Dung Nguyen</a>
  
  </strong></small><p>

      </div>
      <p class="lead"></p>
      <p>Khi viết các API hoặc cả các endpoint thì thông thường chúng ta sẽ có một số nhu cầu:</p><ul><li>Chỉ cho phép một số các tham số xác định được truyền vào.</li><li>Chuyển các tham số về kiểu dữ liệu mong muốn</li><li>Validate các tham số theo yêu cầu</li></ul><p>Bài viết này sẽ hướng dẫn các bạn giải quyết các vấn đề trên sử dụng <code class="inline">Ecto.Changeset</code></p><p>Thư viện <code class="inline">Ecto</code> đã cung cấp sẵn cho chúng ta module <code class="inline">Changeset</code>. Nó hỗ trợ việc cast các tham số về đúng kiểu dữ liệu mong muốn, nó cũng hỗ trợ các phương thức để validate các tham số yêu cầu, và nó cũng cho phép bạn giới hạn tham số nào được truyền vào.</p><p>Và sau đây là một ví dụ sử dụng <code class="inline">Chageset</code> để validate các tham số khi filter các đơn hàng.</p><h2 id="1-dau-tien-ban-phai-dinh-nghia-mot-schema">1. Đầu tiên bạn phải định nghĩa một schema</h2><pre><code class="elixir">defmodule MyApp.OrderFilterParams do
    use Ecto.Schema
    import Ecto.Changeset

    schema "order_filter_params" do
        field :keyword, :string
        field :category_id,  :integer
        field :status, :string
        field :start_date, :utc_datetime
        field :end_date, :utc_datetime
    end
end</code></pre><h2 id="2-cast-va-validate">2. Cast và validate</h2><p>Sau đó phải định nghĩa một hàm để thực hiện việc cast tham số và validate <code class="inline">changeset</code>.</p><pre><code class="elixir">defmodule MyApp.OrderFilterParams do

    ...

    @required ~w(category_id start_date)
    @optional ~w(keyword status end_date)

    def changeset(changeset_or_model, params) do
         cast(changeset_or_model, params, @required ++ @optional)
        |> validate_required(@required)
    end
end</code></pre><h2 id="3-set-gia-tri-default-dong">3. Set giá trị default động</h2><p>Nếu bạn muốn sử dụng các giá trị default động, ví dụ như mặc định ngày kết thúc là ngày hiện tại, các bạn phải định nghĩa một function để set giá trị mong muốn.</p><pre><code class="elixir">defmodule MyApp.OrderFilterParams do

    ...

    def changeset(changeset_or_model, params) do
         cast(changeset_or_model, params, @required ++ @optional)
        |> validate_required(@required)
        |> set_default_end_date()
    end

    defp set_defaut_end_date(changeset) do
        end_date = get_change(changeset, :end_date)
        if is_nil(end_date) do
            put_change(changeset, :end_date, Timex.today())
        else
            changeset
        end
    end
end</code></pre><h2 id="4-su-dung-params-schema">4. Sử dụng Params schema</h2><pre><code class="elixir">defmodule MyApp.OrderController do
    use MyApp, :controller
    alias MyApp.OrderFilterParams

    def index(conn, params) do
        changeset = OrderFilterParams.changeset(%OrderFilterParams{}, params)

        if changeset.valid? do
            strong_params = Ecto.Changeset.apply_changes(changeset)
                IO.put(strong_params.keyword)
            # Do something with your params
        else
            # handle error
        end
    end
end
</code></pre><p>Rất đơn giản đúng không, nếu bạn đã sử dụng <code class="inline">Ecto</code> thì việc này chỉ là ruồi muỗi. Tuy nhiên đơn giản thì phải có thứ đánh đổi chứ.</p><h2 id="vai-thu-ma-ban-se-thay-bat-tien">Vài thứ mà bạn sẽ thấy bất tiện</h2><h3 id="1-luong-code-ma-ban-phai-viet-qua-nhieu">1. Lượng code mà bạn phải viết quá nhiều.</h3><p>Thử tưởng tượng mỗi API bạn lại phải định nghĩa thêm một Module params cho nó thì phức tạp vl.</p><p>Bạn có thể sử dụng schemaless, nhưng mà function của bạn sẽ rối nùi lên vì code logic và code xử lý params nó không liên quan gì tới nhau cả. Và bạn thì kiểu như đổ sting vào cơm để ăn vậy.</p><h3 id="2-thieu-linh-hoat">2. Thiếu linh hoạt.</h3><p>Điều này cũng đúng vì mục đích chính của <code class="inline">Ecto</code> là phục vụ cho việc định nghĩa các schema cho database.</p><p>Đơn giản như việc định nghĩa giá trị default động như trên, bạn phải viết luôn 1 hàm mới</p><p><strong>Tuy nhiên nó cũng có một ưu điểm là bạn không phải sử dụng thêm thư viện của bên thứ ba.</strong></p><h2 id="ket">Kết</h2><p>Nếu bạn không cần phải xử lý nhiều ràng buộc liên quan đến tham số của request thì đơn giản là cứ dùng <code class="inline">Changeset</code> thôi. </p><p>Nếu bạn muốn nhanh gọn hơn thì trên Hex có một số thư viện để hỗ trợ định nghĩa param đơn giản hơn, ví dụ như <a href="https://github.com/bluzky/tarams/">https://github.com/bluzky/tarams/</a></p><p>Thư viện này cung cấp cách thức đơn giản và nhanh chóng hơn để định nghĩa param cho API. Mình sẽ viết bài hướng dẫn sau.</p>
    </article>
  </div>
</div>

      </div>
    </div>
    <footer class="footer text-muted">
  <div class="container-xxl">
    <div class="row">
      <div class="col-lg-8 order-last order-lg-first">
        <ul class="list-inline">
          <li class="list-inline-item">Powered by <a href="https://github.com/bluzky/ego/">Ego</a></li>
        </ul>
      </div>
      <div class="col-lg-8 order-first order-lg-last text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item"><a href="/ego/about">About me</a></li>
          <li class="list-inline-item"><a href="/ego/author">Authors</a></li>
          </ul>
      </div>
    </div>
  </div>
</footer>

    <script src="/ego/js/jquery.min.js" defer></script>
<script src="/ego/js/bootstrap.min.js" defer></script>
<script src="/ego/js/darkmode.js" defer></script>
<script src="/ego/js/alert.js" defer></script>
<script src="/ego/js/index.js" defer></script>

  </body>
</html>
