<!DOCTYPE html>
<html lang="en-US">
  <head>
  <meta charset="utf-8" />
  <title>The Organge+</title>

  <meta name="author" content="Dung Nguyen" />
  <meta
    name="description"
    content=""
  />

  <!-- mobile responsive meta -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
  />

  <!-- Favicon -->
  <link
    rel="icon"
    href="/ego/images/favicon.png"
    type="image/x-icon"
  />

  <!-- CSS Plugins -->
  <!-- plugins + stylesheet -->
<link rel="preconnect" href="https://fonts.gstatic.com" />


<link rel="stylesheet" href="/ego/plugins/bootstrap/bootstrap.min.css" media="screen" />



<link rel="stylesheet" href="/ego/css/style.css" media="screen" />



<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap" />


<link rel="stylesheet" href="/ego/css/style.css" media="screen" />


  
  <script type=application/javascript>
   var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-40665301-3','auto'),ga('send','pageview'))</script>
  

</head>


  <body>
    <div style="min-height: calc(100vh - 65px)">
      <div class="header-height-fix"></div>
<header class="header-nav">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
          <a class="navbar-brand font-weight-bold mr-0" href="">
            
            <img
              loading="lazy"
              src="/ego/images/logo.png"
              alt="The Organge+"
              height="35px"
            />
            
          </a>

          
          <button
            class="search-toggle d-inline-block d-lg-none ml-auto mr-3"
            data-toggle="search"
            aria-label="Search Toggle"
          >
            <i data-eva="search-outline"></i>
          </button>
          

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navHeader"
            aria-controls="navHeader"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i data-eva="menu-outline"></i>
            <i class="d-none" data-eva="close-outline"></i>
          </button>

          <div class="collapse navbar-collapse" id="navHeader">
            <ul
              class="navbar-nav mx-auto"
            >
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego">Blog</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego/tags">Tags</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle d-inline-block "
                  href="#"
                  role="button"
                  data-toggle="dropdown"
                  aria-expanded="false"
                  >More</a
                >
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/categories"
                      >Category</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/elements"
                      >Elements</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/privacy"
                      >Privacy</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/terms-conditions"
                      >Terms & Conditions</a
                    >
                  </li></ul>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego/about">About me</a>
              </li>
              
              
              
            </ul>

            
            <div class="navbar-right d-none d-lg-inline-block">
              <ul class="social-links list-unstyled list-inline">
                <li class="list-inline-item ml-4 d-none d-lg-inline-block">
                  <button
                    class="search-toggle"
                    data-toggle="search"
                    aria-label="Search Toggle"
                  >
                    <i data-eva="search-outline"></i>
                  </button>
                </li>
              </ul>
            </div>
            
          </div>
        </nav>
      </div>
    </div>
  </div>
</header>


<div class="search-block">
  <div data-toggle="search-close">
    <i data-eva="close-outline" class="text-primary"></i>
  </div>
  <form action="/search/">
    <input
      id="search-query"
      name="s"
      type="search"
      placeholder="Type words &amp; hit enter"
      class="text-center"
      aria-label="search-query"
    />
  </form>
</div>



      
      <section class="section-sm pb-2 page-header">
  <div class="container">
    <div class="row">
      <div class="col-8 mx-auto text-center">
        
        <h3 class="mb-3 text-dark font-weight-bold"><p>
How to build an Elixir validator from scratch</p>
</h3>
        


        <ul class="list-inline breadcrumb-menu">
        
        <li class="list-inline-item"><a href="/ego">Home</a></li>
        
        
        
        
        
        
        
        <li class="list-inline-item">/ &nbsp; <a href="/ego/blog">Blog</a></li>
        
        
        
        
        
        <li class="list-inline-item">/ &nbsp; <a href="/ego/blog/2021-07-31-build-elixir-validator-from-scratch">2021-07-31-build-elixir-validator-from-scratch</a></li>
        
        
        
        </ul>
      </div>
    </div>
  </div>
</section>

      

      <!-- checking blog -->


<section class="section-sm">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="content"><p>Validation is a must have part of web application. You have to validate request parameter before processing, you validate data before inserting to database, and many more.</p><p>Normally, I use <code class="inline">Ecto.Changeset</code> to do validation job. But it comes with changeset, I have to build schema, changeset then do the validation. Sometime you just don't need too much thing like that.</p><p>So today we are going to build a simple validation module to use without changeset, or in some project you don't use <code class="inline">Ecto</code>, or just for learning.</p><h2 id="what-our-validation-module-includes">What our validation module includes:</h2><ul><li>Type validation</li><li>Number validation</li><li>Length validation for <code class="inline">map, list, string</code></li><li>String format validation using regex</li><li>Inclusion, exclusion validations</li></ul><p>That's is quite enough, you can define more if you want.
And the module will support a simple API to validate a value</p><pre><code class="elixir">validate(value::any(), validations::keyword()) :: :ok | {:error, String.t()}</code></pre><p>Let's start.</p><h2 id="type-validation">Type validation</h2><p>Let's call our module <code class="inline">Checky</code>. Type check is quite straight forward. Elixir support most of type check guard that we need:</p><pre><code class="elixir">defmodule Checky do
  def validate_type(value, :boolean) when is_boolean(value), do: :ok
  def validate_type(value, :integer) when is_integer(value), do: :ok
  def validate_type(value, :float) when is_float(value), do: :ok
  def validate_type(value, :number) when is_number(value), do: :ok
  def validate_type(value, :string) when is_binary(value), do: :ok
  def validate_type(value, :binary) when is_binary(value), do: :ok
  def validate_type(value, :tuple) when is_tuple(value), do: :ok
  def validate_type(value, :array) when is_list(value), do: :ok
  def validate_type(value, :list) when is_list(value), do: :ok
  def validate_type(value, :atom) when is_atom(value), do: :ok
  def validate_type(value, :function) when is_function(value), do: :ok
  def validate_type(value, :map) when is_map(value), do: :ok
  # we will add some more validation here
  def validate_type(_, type), do: {:error, "is not a #{type}"}
end</code></pre><p>Easy, right? Now let's support checking for <code class="inline">struct</code>:</p><pre><code class="elixir">defmodule Checky do

  ...
  # from Elixir 1.12 you can do this
  def validate_type(value, struct_name) when is_struct(value, struct_name), do: :ok
  # this is for Elixir before 1.12
  def validate_type(%{__struct__: struct}, struct_name) when struct == struct_name, do: :ok
  ...
end</code></pre><ul><li>Here we check for <code class="inline">keyword</code></li></ul><pre><code class="elixir">defmodule Checky do
  ...
  # empty list is also a empty keyword
  def validate_type([] = _check_item, :keyword), do: :ok
  # if list item is a tuple of 2 and first element is atom then it is a keyword list
  def validate_type(items, :keyword) when is_list(items) do
    valid? = Enum.all(item, fn 
        {key, _} when is_atom(key) -> true
        _ -> false 
    end)
    
    if valid? do
      :ok
    else
      {:error, "is not a keyword"}
    end
  end
  ...
end</code></pre><ul><li>Now let support array check <code class="inline">{:array, type}</code> which is similar to <code class="inline">Ecto.Schema</code>.</li></ul><pre><code class="elixir">defmodule Checky do
  ...
  def validate_type(value, {:array, type}) when is_list(value) do
    # We will check type for each value in the list
    array(value, &validate_type(&1, type))
  end
  ...
   # loop and validate element in array using `validate_func`
  defp array(data, validate_func)

  defp array([], _) do
    :ok
  end

  # validate recursively, and return error if any vadation failed
  defp array([h | t], validate_func) do
    case validate_func.(h) do
      :ok ->
        array(t, validate_func)
      err ->
        err
    end
  end
end</code></pre><p>Phew! We have done with type validation. You can add more type validation if you want.</p><h2 id="format-validation">Format Validation</h2><p>This validation is super easy, <code class="inline">Regex</code> do that for us:</p><pre><code class="elixir">defmodule Checky end
  def validate_format(value, check) when is_binary(value) do
    if Regex.match?(check, value), do: :ok, else: {:error, "does not match format"}
  end

  def validate_format(_value, _check) do
    {:error, "format check only support string"}
  end
end</code></pre><h2 id="inclusion-and-exclusion-validation">Inclusion and exclusion validation</h2><p>These are trivial checks too. Just make sure it is implement <code class="inline">Enumerable</code> protocol.</p><pre><code class="elixir">defmodule Checky do
  def validate_inclusion(value, enum) do
    if Enumerable.impl_for(enum) do
      if Enum.member?(enum, value) do
        :ok
      else
        {:error, "not be in the inclusion list"}
      end
    else
      {:error, "given condition does not implement protocol Enumerable"}
    end
  end

  @doc """
  Check if value is **not** included in the given enumerable. Similar to `validate_inclusion/2`
  """
  def validate_exclusion(value, enum) do
    if Enumerable.impl_for(enum) do
      if Enum.member?(enum, value) do
        {:error, "must not be in the exclusion list"}
      else
        :ok
      end
    else
      {:error, "given condition does not implement protocol Enumerable"}
    end
  end
end</code></pre><h2 id="number-validation">Number validation</h2><p>This is one of the most complicated part of our module. It's not difficult, it's just long.
We will support following checks:</p><ul><li><code class="inline">equal_to</code></li><li><code class="inline">greater_than_or_equal_to</code> | <code class="inline">min</code></li><li><code class="inline">greater_than</code></li><li><code class="inline">less_than</code></li><li><code class="inline">less_than_or_equal_to</code> | <code class="inline">max</code></li></ul><p>And it should support multiple check like this:</p><pre><code class="elixir"> validate_number(x, [min: 10, max: 20])</code></pre><p>First we code validation function for single condition like this</p><pre><code class="elixir">  def validate_number(number, {:equal_to, check_value}) do
    if number == check_value do
      :ok
    else
      {:error, "must be equal to #{check_value}"}
    end
  end</code></pre><p>As I said, it's so simple. You can fill the remaining check right? Or you can check the final code at the end of the post.
After implementing all validation fucntion for number, it's time to support multiple condtion check.</p><pre><code class="elixir">  @spec validate_number(integer() | float(), keyword()) :: :ok | error
  def validate_number(value, checks) when is_list(checks) do
    if is_number(value) do
      checks
      |> Enum.reduce(:ok, fn
        check, :ok ->
          validate_number(value, check)

        _, error ->
          error
      end)
    else
      {:error, "must be a number"}
    end
  end</code></pre><h2 id="length-validation">Length validation</h2><p>Length is just a number, so we can reuse number validation. We just have to check if given value is one of support types: <code class="inline">list</code>, <code class="inline">map</code>, <code class="inline">string</code>, and <code class="inline">tuple</code></p><p>We will implement <code class="inline">get_length/1</code> function to get data length first.</p><pre><code class="elixir">  @spec get_length(any) :: pos_integer() | {:error, :wrong_type}
  defp get_length(param) when is_list(param), do: length(param)
  defp get_length(param) when is_binary(param), do: String.length(param)
  defp get_length(param) when is_map(param), do: param |> Map.keys() |> get_length()
  defp get_length(param) when is_tuple(param), do: tuple_size(param)
  defp get_length(_param), do: {:error, :wrong_type}</code></pre><p>Then we do number validation on the length value</p><pre><code class="elixir">  @spec validate_length(support_length_types, keyword()) :: :ok | error
  def validate_length(value, checks) do
    with length when is_integer(length) <- get_length(value),
         # validation length number
         :ok <- validate_number(length, checks) do
      :ok
    else
      {:error, :wrong_type} ->
        {:error, "length check supports only lists, binaries, maps and tuples"}

      {:error, msg} ->
        # we prepend length to message return by validation number to get full message
        # like: "length must be equal to x"
        {:error, "length #{msg}"}
    end
  end</code></pre><h2 id="combine-all-validation">Combine all validation</h2><p>Most of time you want to use multiple valitions on the data. So we will add a function that do multiple validation</p><p>We define a simple structure for validation first. This is our validate function spec</p><pre><code class="elixir"> @spec validate(any(), keyword()) :: :ok | {:error, messages}</code></pre><p>Then we can use it like this:</p><pre><code class="elixir">Checky.validate(value, type: :string, format: ~r/\d\d.+/, length: [min: 8, max: 20])</code></pre><p>Validations is a keyword list with short name for validation:</p><ul><li><code class="inline">:type</code> -> <code class="inline">validate_type</code></li><li><code class="inline">:format</code> -> <code class="inline">validate_format</code></li><li><code class="inline">:in</code> -> <code class="inline">validate_inclusion</code></li><li><code class="inline">:not_in</code> -> <code class="inline">validate_exclusion</code></li><li><code class="inline">:number</code> -> <code class="inline">validate_number</code></li><li><code class="inline">:length</code> -> <code class="inline">validate_length</code></li></ul><p><strong>Define mapping function:</strong></p><pre><code class="elixir">  defp get_validator(:type), do: &validate_type/2
  defp get_validator(:format), do: &validate_format/2
  defp get_validator(:number), do: &validate_number/2
  defp get_validator(:length), do: &validate_length/2
  defp get_validator(:in), do: &validate_inclusion/2
  defp get_validator(:not_in), do: &validate_exclusion/2
  defp get_validator(name), do: {:error, "validate_#{name} is not support"}
</code></pre><p><strong>Go checking validations one by one</strong></p><pre><code class="elixir">  def validate(value, validators) do
    do_validate(value, validators, :ok)
  end

  defp do_validate(_, [], acc), do: acc

  # check validations one by one
  defp do_validate(value, [h | t] = _validators, acc) do
    case do_validate(value, h) do
      :ok -> do_validate(value, t, acc)
      error -> error
    end
  end

  # validate single validation
  defp do_validate(value, {validator, opts}) do
    case get_validator(validator) do
      {:error, _} = err -> err
      validate_func -> validate_func.(value, opts)
    end
  end</code></pre><h2 id="conclusion">Conclusion</h2><p>Writing a validation module is not so hard. Now you can add more validations to fit your need. As I promised, this is the full source of the module with custom validation fucntion.
<a href="https://github.com/bluzky/valdi/blob/main/lib/valdi.ex">https://github.com/bluzky/valdi/blob/main/lib/valdi.ex</a></p><p>Thank you for reading to the end of this post. Please leave me a comment.</p></div>
      </div>
    </div>
  </div>
</section>


    </div>
    <footer class="section-sm p-0">
  <div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-lg-5">
         
      </div>
      <div class="col-lg-12 text-center mb-3">
        
        <ul
          class="social-links icon-box list-unstyled list-inline font-weight-500 mb-3"
        >
          
        </ul>

        <p class="mb-0 font-weight-500 copyright-text content">
          <p>
Blog by Dung Nguyen.Theme by <a href="https://gethugothemes.com/">Gethugothemes</a></p>

        </p>
      </div>
    </div>
  </div>
</footer>

    <!-- JS Plugins + Main script -->


<script data-turbolinks-suppress-warning src="/ego/plugins/jquery/jquery.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/bootstrap/bootstrap.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/fuse.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/mark.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/search.js"></script>
 

<script src="https://unpkg.com/eva-icons"></script>
 

<script
  data-turbolinks-suppress-warning
  src="/ego/js/script.js"
></script>

<!-- cookie -->


<!-- DISQUS -->

<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
  */
  (function () {
    // DON'T EDIT BELOW THIS LINE
    var d = document,
      s = d.createElement("script");
    s.src = "https://.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>


  </body>
</html>
