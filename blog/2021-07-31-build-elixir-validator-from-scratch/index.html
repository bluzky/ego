<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font -->
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-700.woff2" type="font/woff2" crossorigin>

  <!-- script -->
  <script src="/ego/js/darkmode-init.js"></script>
  <!-- stylesheet -->
  <link rel="stylesheet" href="/ego/css/main.css" crossorigin="anonymous">
  <noscript><style>img.lazyload { display: none; }</style></noscript>

  <!-- seo -->
 

  <!-- Favicon -->
  <meta name="theme-color" content="">
  <link rel="apple-touch-icon" sizes="180x180" href="/ego/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/ego/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ego/favicon-16x16.png">
  <link rel="manifest" crossorigin="use-credentials" href="/ego/site.webmanifest">

</head>


  <body class="blog list">
     <div class="header-bar"></div>

<header class="navbar navbar-expand-md navbar-light doks-navbar">
  <nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation">
    <a class="navbar-brand p-0 me-auto" href="/" aria-label="Ego">
      Ego
    </a>

    <button class="btn btn-menu d-block d-md-none order-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDoks" aria-controls="offcanvasDoks" aria-label="Open main menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="offcanvas offcanvas-start border-0 py-md-1" tabindex="-1" id="offcanvasDoks" data-bs-backdrop="true" aria-labelledby="offcanvasDoksLabel">
      <div class="header-bar d-md-none"></div>
      <div class="offcanvas-header d-md-none">
        <h2 class="h5 offcanvas-title ps-2" id="offcanvasDoksLabel"><a class="text-dark" href="/">Ego</a></h2>
        <button type="button" class="btn-close text-reset me-2" data-bs-dismiss="offcanvas" aria-label="Close main menu"></button>
      </div>
      <div class="offcanvas-body px-4">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3>
        <ul class="nav flex-column flex-md-row ms-md-n3">
          
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/docs/prologue/introduction">Docs</a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/blog">Blog</a>
            </li>
          </ul>
        <hr class="text-black-50 my-4 d-md-none">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3>
        <ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2">
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://github.com/h-enk/doks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><small class="ms-2 d-md-none">GitHub</small></a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://twitter.com/getdoks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><small class="ms-2 d-md-none">Twitter</small></a>
            </li>
          </ul>
      </div>
    </div>

    <button id="mode" class="btn btn-link order-md-1" type="button" aria-label="Toggle user interface mode">
      <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
      <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
    </button>
    </nav>
</header>


    <div class="wrap container-xxl" role="document">
      <div class="content">
        
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-10 col-xl-8">
    <article>
      <div class="blog-header">
        <h1>How to build an Elixir validator from scratch</h1>
        <p><small>Posted 2021-07-31 by
  <a class="stretched-link position-relative" href="/contributors/dung-nguyen/">Dung Nguyen</a>
  
  </strong></small><p>

      </div>
      <p class="lead"></p>
      <p>Validation is a must have part of web application. You have to validate request parameter before processing, you validate data before inserting to database, and many more.</p><p>Normally, I use <code class="inline">Ecto.Changeset</code> to do validation job. But it comes with changeset, I have to build schema, changeset then do the validation. Sometime you just don't need too much thing like that.</p><p>So today we are going to build a simple validation module to use without changeset, or in some project you don't use <code class="inline">Ecto</code>, or just for learning.</p><h2 id="what-our-validation-module-includes">What our validation module includes:</h2><ul><li>Type validation</li><li>Number validation</li><li>Length validation for <code class="inline">map, list, string</code></li><li>String format validation using regex</li><li>Inclusion, exclusion validations</li></ul><p>That's is quite enough, you can define more if you want.
And the module will support a simple API to validate a value</p><pre><code class="elixir">validate(value::any(), validations::keyword()) :: :ok | {:error, String.t()}</code></pre><p>Let's start.</p><h2 id="type-validation">Type validation</h2><p>Let's call our module <code class="inline">Checky</code>. Type check is quite straight forward. Elixir support most of type check guard that we need:</p><pre><code class="elixir">defmodule Checky do
  def validate_type(value, :boolean) when is_boolean(value), do: :ok
  def validate_type(value, :integer) when is_integer(value), do: :ok
  def validate_type(value, :float) when is_float(value), do: :ok
  def validate_type(value, :number) when is_number(value), do: :ok
  def validate_type(value, :string) when is_binary(value), do: :ok
  def validate_type(value, :binary) when is_binary(value), do: :ok
  def validate_type(value, :tuple) when is_tuple(value), do: :ok
  def validate_type(value, :array) when is_list(value), do: :ok
  def validate_type(value, :list) when is_list(value), do: :ok
  def validate_type(value, :atom) when is_atom(value), do: :ok
  def validate_type(value, :function) when is_function(value), do: :ok
  def validate_type(value, :map) when is_map(value), do: :ok
  # we will add some more validation here
  def validate_type(_, type), do: {:error, "is not a #{type}"}
end</code></pre><p>Easy, right? Now let's support checking for <code class="inline">struct</code>:</p><pre><code class="elixir">defmodule Checky do

  ...
  # from Elixir 1.12 you can do this
  def validate_type(value, struct_name) when is_struct(value, struct_name), do: :ok
  # this is for Elixir before 1.12
  def validate_type(%{__struct__: struct}, struct_name) when struct == struct_name, do: :ok
  ...
end</code></pre><ul><li>Here we check for <code class="inline">keyword</code></li></ul><pre><code class="elixir">defmodule Checky do
  ...
  # empty list is also a empty keyword
  def validate_type([] = _check_item, :keyword), do: :ok
  # if list item is a tuple of 2 and first element is atom then it is a keyword list
  def validate_type(items, :keyword) when is_list(items) do
    valid? = Enum.all(item, fn 
        {key, _} when is_atom(key) -> true
        _ -> false 
    end)
    
    if valid? do
      :ok
    else
      {:error, "is not a keyword"}
    end
  end
  ...
end</code></pre><ul><li>Now let support array check <code class="inline">{:array, type}</code> which is similar to <code class="inline">Ecto.Schema</code>.</li></ul><pre><code class="elixir">defmodule Checky do
  ...
  def validate_type(value, {:array, type}) when is_list(value) do
    # We will check type for each value in the list
    array(value, &validate_type(&1, type))
  end
  ...
   # loop and validate element in array using `validate_func`
  defp array(data, validate_func)

  defp array([], _) do
    :ok
  end

  # validate recursively, and return error if any vadation failed
  defp array([h | t], validate_func) do
    case validate_func.(h) do
      :ok ->
        array(t, validate_func)
      err ->
        err
    end
  end
end</code></pre><p>Phew! We have done with type validation. You can add more type validation if you want.</p><h2 id="format-validation">Format Validation</h2><p>This validation is super easy, <code class="inline">Regex</code> do that for us:</p><pre><code class="elixir">defmodule Checky end
  def validate_format(value, check) when is_binary(value) do
    if Regex.match?(check, value), do: :ok, else: {:error, "does not match format"}
  end

  def validate_format(_value, _check) do
    {:error, "format check only support string"}
  end
end</code></pre><h2 id="inclusion-and-exclusion-validation">Inclusion and exclusion validation</h2><p>These are trivial checks too. Just make sure it is implement <code class="inline">Enumerable</code> protocol.</p><pre><code class="elixir">defmodule Checky do
  def validate_inclusion(value, enum) do
    if Enumerable.impl_for(enum) do
      if Enum.member?(enum, value) do
        :ok
      else
        {:error, "not be in the inclusion list"}
      end
    else
      {:error, "given condition does not implement protocol Enumerable"}
    end
  end

  @doc """
  Check if value is **not** included in the given enumerable. Similar to `validate_inclusion/2`
  """
  def validate_exclusion(value, enum) do
    if Enumerable.impl_for(enum) do
      if Enum.member?(enum, value) do
        {:error, "must not be in the exclusion list"}
      else
        :ok
      end
    else
      {:error, "given condition does not implement protocol Enumerable"}
    end
  end
end</code></pre><h2 id="number-validation">Number validation</h2><p>This is one of the most complicated part of our module. It's not difficult, it's just long.
We will support following checks:</p><ul><li><code class="inline">equal_to</code></li><li><code class="inline">greater_than_or_equal_to</code> | <code class="inline">min</code></li><li><code class="inline">greater_than</code></li><li><code class="inline">less_than</code></li><li><code class="inline">less_than_or_equal_to</code> | <code class="inline">max</code></li></ul><p>And it should support multiple check like this:</p><pre><code class="elixir"> validate_number(x, [min: 10, max: 20])</code></pre><p>First we code validation function for single condition like this</p><pre><code class="elixir">  def validate_number(number, {:equal_to, check_value}) do
    if number == check_value do
      :ok
    else
      {:error, "must be equal to #{check_value}"}
    end
  end</code></pre><p>As I said, it's so simple. You can fill the remaining check right? Or you can check the final code at the end of the post.
After implementing all validation fucntion for number, it's time to support multiple condtion check.</p><pre><code class="elixir">  @spec validate_number(integer() | float(), keyword()) :: :ok | error
  def validate_number(value, checks) when is_list(checks) do
    if is_number(value) do
      checks
      |> Enum.reduce(:ok, fn
        check, :ok ->
          validate_number(value, check)

        _, error ->
          error
      end)
    else
      {:error, "must be a number"}
    end
  end</code></pre><h2 id="length-validation">Length validation</h2><p>Length is just a number, so we can reuse number validation. We just have to check if given value is one of support types: <code class="inline">list</code>, <code class="inline">map</code>, <code class="inline">string</code>, and <code class="inline">tuple</code></p><p>We will implement <code class="inline">get_length/1</code> function to get data length first.</p><pre><code class="elixir">  @spec get_length(any) :: pos_integer() | {:error, :wrong_type}
  defp get_length(param) when is_list(param), do: length(param)
  defp get_length(param) when is_binary(param), do: String.length(param)
  defp get_length(param) when is_map(param), do: param |> Map.keys() |> get_length()
  defp get_length(param) when is_tuple(param), do: tuple_size(param)
  defp get_length(_param), do: {:error, :wrong_type}</code></pre><p>Then we do number validation on the length value</p><pre><code class="elixir">  @spec validate_length(support_length_types, keyword()) :: :ok | error
  def validate_length(value, checks) do
    with length when is_integer(length) <- get_length(value),
         # validation length number
         :ok <- validate_number(length, checks) do
      :ok
    else
      {:error, :wrong_type} ->
        {:error, "length check supports only lists, binaries, maps and tuples"}

      {:error, msg} ->
        # we prepend length to message return by validation number to get full message
        # like: "length must be equal to x"
        {:error, "length #{msg}"}
    end
  end</code></pre><h2 id="combine-all-validation">Combine all validation</h2><p>Most of time you want to use multiple valitions on the data. So we will add a function that do multiple validation</p><p>We define a simple structure for validation first. This is our validate function spec</p><pre><code class="elixir"> @spec validate(any(), keyword()) :: :ok | {:error, messages}</code></pre><p>Then we can use it like this:</p><pre><code class="elixir">Checky.validate(value, type: :string, format: ~r/\d\d.+/, length: [min: 8, max: 20])</code></pre><p>Validations is a keyword list with short name for validation:</p><ul><li><code class="inline">:type</code> -> <code class="inline">validate_type</code></li><li><code class="inline">:format</code> -> <code class="inline">validate_format</code></li><li><code class="inline">:in</code> -> <code class="inline">validate_inclusion</code></li><li><code class="inline">:not_in</code> -> <code class="inline">validate_exclusion</code></li><li><code class="inline">:number</code> -> <code class="inline">validate_number</code></li><li><code class="inline">:length</code> -> <code class="inline">validate_length</code></li></ul><p><strong>Define mapping function:</strong></p><pre><code class="elixir">  defp get_validator(:type), do: &validate_type/2
  defp get_validator(:format), do: &validate_format/2
  defp get_validator(:number), do: &validate_number/2
  defp get_validator(:length), do: &validate_length/2
  defp get_validator(:in), do: &validate_inclusion/2
  defp get_validator(:not_in), do: &validate_exclusion/2
  defp get_validator(name), do: {:error, "validate_#{name} is not support"}
</code></pre><p><strong>Go checking validations one by one</strong></p><pre><code class="elixir">  def validate(value, validators) do
    do_validate(value, validators, :ok)
  end

  defp do_validate(_, [], acc), do: acc

  # check validations one by one
  defp do_validate(value, [h | t] = _validators, acc) do
    case do_validate(value, h) do
      :ok -> do_validate(value, t, acc)
      error -> error
    end
  end

  # validate single validation
  defp do_validate(value, {validator, opts}) do
    case get_validator(validator) do
      {:error, _} = err -> err
      validate_func -> validate_func.(value, opts)
    end
  end</code></pre><h2 id="conclusion">Conclusion</h2><p>Writing a validation module is not so hard. Now you can add more validations to fit your need. As I promised, this is the full source of the module with custom validation fucntion.
<a href="https://github.com/bluzky/valdi/blob/main/lib/valdi.ex">https://github.com/bluzky/valdi/blob/main/lib/valdi.ex</a></p><p>Thank you for reading to the end of this post. Please leave me a comment.</p>
    </article>
  </div>
</div>

      </div>
    </div>
    <footer class="footer text-muted">
  <div class="container-xxl">
    <div class="row">
      <div class="col-lg-8 order-last order-lg-first">
        <ul class="list-inline">
          <li class="list-inline-item">Powered by <a href="https://github.com/bluzky/ego/">Ego</a></li>
        </ul>
      </div>
      <div class="col-lg-8 order-first order-lg-last text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item"><a href="/ego/about">About me</a></li>
          <li class="list-inline-item"><a href="/ego/author">Authors</a></li>
          </ul>
      </div>
    </div>
  </div>
</footer>

    <script src="/ego/js/jquery.min.js" defer></script>
<script src="/ego/js/bootstrap.min.js" defer></script>
<script src="/ego/js/highlight.js" defer></script>
<script src="/ego/js/darkmode.js" defer></script>
<script src="/ego/js/alert.js" defer></script>
<script src="/ego/js/index.js" defer></script>

  </body>
</html>
