<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font -->
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="/ego/fonts/vendor/jost/jost-v4-latin-700.woff2" type="font/woff2" crossorigin>

  <!-- script -->
  <script src="/ego/js/darkmode-init.js"></script>
  <!-- stylesheet -->
  <link rel="stylesheet" href="/ego/css/main.css" crossorigin="anonymous">
  <noscript><style>img.lazyload { display: none; }</style></noscript>

  <!-- seo -->
 

  <!-- Favicon -->
  <meta name="theme-color" content="">
  <link rel="apple-touch-icon" sizes="180x180" href="/ego/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/ego/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ego/favicon-16x16.png">
  <link rel="manifest" crossorigin="use-credentials" href="/ego/site.webmanifest">

</head>


  <body class="blog list">
     <div class="header-bar"></div>

<header class="navbar navbar-expand-md navbar-light doks-navbar">
  <nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation">
    <a class="navbar-brand p-0 me-auto" href="/" aria-label="Ego">
      Ego
    </a>

    <button class="btn btn-menu d-block d-md-none order-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDoks" aria-controls="offcanvasDoks" aria-label="Open main menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="offcanvas offcanvas-start border-0 py-md-1" tabindex="-1" id="offcanvasDoks" data-bs-backdrop="true" aria-labelledby="offcanvasDoksLabel">
      <div class="header-bar d-md-none"></div>
      <div class="offcanvas-header d-md-none">
        <h2 class="h5 offcanvas-title ps-2" id="offcanvasDoksLabel"><a class="text-dark" href="/">Ego</a></h2>
        <button type="button" class="btn-close text-reset me-2" data-bs-dismiss="offcanvas" aria-label="Close main menu"></button>
      </div>
      <div class="offcanvas-body px-4">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3>
        <ul class="nav flex-column flex-md-row ms-md-n3">
          
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/docs/prologue/introduction">Docs</a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/blog">Blog</a>
            </li>
          </ul>
        <hr class="text-black-50 my-4 d-md-none">
        <h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3>
        <ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2">
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://github.com/h-enk/doks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><small class="ms-2 d-md-none">GitHub</small></a>
            </li>
          <li class="nav-item">
              <a class="nav-link ps-0 py-1" href="/ego/https://twitter.com/getdoks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><small class="ms-2 d-md-none">Twitter</small></a>
            </li>
          </ul>
      </div>
    </div>

    <button id="mode" class="btn btn-link order-md-1" type="button" aria-label="Toggle user interface mode">
      <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
      <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
    </button>
    </nav>
</header>


    <div class="wrap container-xxl" role="document">
      <div class="content">
        
<div class="row justify-content-center">
  <div class="col-md-12 col-lg-10 col-xl-8">
    <article>
      <div class="blog-header">
        <h1>Build your own library to render json response in Phoenix</h1>
        <p><small>Posted 2021-07-23 by
  <a class="stretched-link position-relative" href="/contributors/dung-nguyen/">Dung Nguyen</a>
  
  </strong></small><p>

      </div>
      <p class="lead"></p>
      <p>In my previous article, I introduced my library call <code class="inline">JsonView</code> to render json response easier. You can read it here:
<a href="/blog/2021-07-10-render-response-json-view">Render Ecto schema to json with relationships with JsonView</a></p><p>Today I will guide you to write your own Json render view. Let's start.</p><p>Now for example I have a Blog app with <code class="inline">User</code> <code class="inline">Category</code> , <code class="inline">Post</code> and <code class="inline">Comment</code> schemas.</p><p>This is <code class="inline">PostView</code> which is generated by <code class="inline">Phoenix</code></p><pre><code class="elixir">defmodule MyBlogWeb.PostView do
  use MyBlogWeb, :view
  alias MyBlogWeb.PostView

  def render("index.json", %{posts: posts}) do
    %{data: render_many(posts, PostView, "post.json")}
  end

  def render("show.json", %{post: post}) do
    %{data: render_one(post, PostView, "post.json")}
  end

  def render("post.json", %{post: post}) do
    %{id: post.id,
      title: post.title,
      description: post.description,
      content: post.content,
      cover: post.cover,
      is_published: post.is_published}
  end
end
</code></pre><p><strong>Let's improve it</strong></p><h3 id="1-use-map-take">1. Use <code class="inline">Map.take</code></h3><pre><code class="elixir">...
def render("post.json", %{post: post}) do
        Map.take(post, [:id, :title, :description, :content, :cover, :is_published])
end
...</code></pre><p>This way you don't have to write much code every time you add a new attribute.</p><h3 id="2-render-custom-field">2. Render custom field</h3><p>You may want to:</p><ul><li>Format some field value instead of return original value</li><li>Calculate virtual field</li></ul><p>Normally you will do this:</p><pre><code class="elixir">    def render("post.json", %{post: post}) do
    post
    |> Map.take([:id, :title, :description, :content, :cover, :is_published])
    |> Map.merge(%{
      comment_count: render_comment_count(post),
      author_name: render_author_name(post)
    })
  end

  def render_comment_count(post) do
    ...
  end

  def render_author_name(post) do
    ...
  end</code></pre><p>Or you can reduce a bit of code by using pattern matching to render custom field value</p><pre><code class="elixir">    def render("post.json", %{post: post}) do
    post
    |> Map.take([:id, :title, :description, :content, :cover, :is_published])
    |> Map.merge(render_custom_fields(post, [:comment_count, :author_name]))
  end

  defp render_custom_fields(struct, fields) do
    Enum.map(fields, fn field ->
        {field, render_field(field, struct)}
    end)
    |> Enum.into(%{})
  end

  defp render_field(:comment_count, post) do
    ...
  end

  defp render_field(:author_name, post) do
    ...
  end</code></pre><p>Now every time you add a new custom field, just add field name to the list, and define a <code class="inline">render_field/2</code> function</p><h3 id="3-render-relation-ship">3. Render relation ship</h3><p>You may want to return the whole object of author. For example you have a view <code class="inline">UserView</code> so you can do:</p><pre><code class="elixir"> def render("post.json", %{post: post}) do
    post
    ...
    |> Map.merge(%{
      author: render_one(post.author, MyBlogWeb.UserView, "user.json")
    })
 end</code></pre><p>It requires that author must be loaded, if not, you will get this error</p><pre><code>** (KeyError) key :id not found in: #Ecto.Association.NotLoaded<association :author is not loaded></code></pre><p>You can handle it by pattern matching against <code class="inline">Ecto.Association.NotLoaded</code></p><pre><code class="elixir"> def render("post.json", %{post: post}) do
    post
    ...
    |> Map.merge(%{
      author: render_relationship(post.author, MyBlogWeb.UserView, "user.json")
    })
 end
 
 defp render_relationship(%Ecto.Association.NotLoaded{}, _, _), do: nil
 
 defp render_relationship(relation, view, template) do
    render_one(relation, view, template)
 end</code></pre><p>And it only render relations struct if loaded, otherwise it is set to nil.</p><p>Now you can improve it to render list of relationships</p><pre><code class="elixir">def render("post.json", %{post: post}) do
    post
    ...
    |> Map.merge(
      render_relationship(post, [
        {:author, MyBlogWeb.UserView, "user.json"},
        {:comments, MyBlogWeb.CommentView, "comment.json"}
      ])
    )
end

defp render_relationship(struct, relationships) do
    Enum.map(relationships, fn {field, view, template} ->
      {field, render_relationship(Map.get(struct, field), view, template)}
    end)
    |> Enum.into(%{})
end

defp render_relationship(%Ecto.Association.NotLoaded{}, _, _), do: nil

defp render_relationship(relations, view, template) when is_list(relations) do
    render_many(relations, view, template)
end

defp render_relationship(relation, view, template) do
    render_one(relation, view, template)
end</code></pre><p>With this way you can handle both single struct and list of struct.</p><h3 id="4-combines-these-helper-functions">4. Combines these helper functions</h3><p>You can combine them all in one function and only need to pass field definition to this function</p><pre><code class="elixir">@fields [:id, :title, :description, :content, :cover, :is_published]
  @custom_fiels [:comment_count, :author_name]
  @relationships [
    {:author, MyBlogWeb.UserView, "user.json"},
    {:comments, MyBlogWeb.CommentView, "comment.json"}
  ]

  def render("post.json", %{post: post}) do
    render_json(post, @fields, @custom_fiels, @relationships)
  end

  def render_json(struct, fields, custom_fields \\ [], relationships \\ []) do
    struct
    |> Map.take(fields)
    |> Map.merge(render_custom_fields(struct, custom_fields))
    |> Map.merge(render_relationship(struct, relationships))
  end</code></pre><h2 id="move-them-to-a-helper">Move them to a helper</h2><p>These functions are the same for every view, so let's move these code to a helper module <code class="inline">JsonViewHelper</code></p><pre><code class="elixir">defmodule JsonViewHelper do
  import Phoenix.View, only: [render_one: 3, render_many: 3]

  def render_json(struct, view, fields, custom_fields \\ [], relationships \\ []) do
    struct
    |> Map.take(fields)
    |> Map.merge(render_custom_fields(struct, view, custom_fields))
    |> Map.merge(render_relationship(struct, relationships))
  end

  defp render_custom_fields(struct, view, fields) do
    Enum.map(fields, fn field ->
      {field, view.render_field(field, struct)}
    end)
    |> Enum.into(%{})
  end

  defp render_relationship(struct, relationships) do
    Enum.map(relationships, fn {field, view, template} ->
      {field, render_relationship(Map.get(struct, field), view, template)}
    end)
    |> Enum.into(%{})
  end

  defp render_relationship(%Ecto.Association.NotLoaded{}, _, _), do: nil

  defp render_relationship(relations, view, template) when is_list(relations) do
    render_many(relations, view, template)
  end

  defp render_relationship(relation, view, template) do
    render_one(relation, view, template)
  end
end</code></pre><p>Here I modify <code class="inline">render_custom_fields</code> a bit, because we call <code class="inline">render_field</code> to render custom field, so we have pass the view module as second parameter, so we can use the module to invoke those <code class="inline">render_field</code> that we define.</p><p>And now render json response is much simple:</p><pre><code class="elixir">defmodule BlogeeWeb.PostView do
    ...
  @fields [:id, :title, :description, :content, :cover]
  @custom_fields [:status]
  @relationships [
    {:author, BlogeeWeb.UserView, "basic_info.json"},
    {:category, BlogeeWeb.CategoryView, "category.json"}
  ]
  def render("post.json", %{post: post}) do
    JsonViewHelper.render_json(post, __MODULE__, @fields, @custom_fields, @relationships)
  end

  def render_field(:status, post) do
    if post.is_published do
      "published"
    else
      "draft"
    end
  end
end</code></pre><h2 id="hooray">Hooray</h2><p>Thank you for reading to the end of this article. Hope that this can help.
If you want to use render hook, take a look at my github for full code</p><p><a href="https://github.com/bluzky/json_view">https://github.com/bluzky/json_view</a></p>
    </article>
  </div>
</div>

      </div>
    </div>
    <footer class="footer text-muted">
  <div class="container-xxl">
    <div class="row">
      <div class="col-lg-8 order-last order-lg-first">
        <ul class="list-inline">
          <li class="list-inline-item">Powered by <a href="https://github.com/bluzky/ego/">Ego</a></li>
        </ul>
      </div>
      <div class="col-lg-8 order-first order-lg-last text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item"><a href="/ego/about">About me</a></li>
          <li class="list-inline-item"><a href="/ego/author">Authors</a></li>
          </ul>
      </div>
    </div>
  </div>
</footer>

    <script src="/ego/js/jquery.min.js" defer></script>
<script src="/ego/js/bootstrap.min.js" defer></script>
<script src="/ego/js/darkmode.js" defer></script>
<script src="/ego/js/alert.js" defer></script>
<script src="/ego/js/index.js" defer></script>

  </body>
</html>
