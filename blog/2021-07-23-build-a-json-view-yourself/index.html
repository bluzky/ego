<!DOCTYPE html>
<html lang="en-US">
  <head>
  <meta charset="utf-8" />
  <title>The Organge+</title>

  <meta name="author" content="Dung Nguyen" />
  <meta
    name="description"
    content=""
  />

  <!-- mobile responsive meta -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
  />

  <!-- Favicon -->
  <link
    rel="icon"
    href="/ego/images/favicon.png"
    type="image/x-icon"
  />

  <!-- CSS Plugins -->
  <!-- plugins + stylesheet -->
<link rel="preconnect" href="https://fonts.gstatic.com" />


<link rel="stylesheet" href="/ego/plugins/bootstrap/bootstrap.min.css" media="screen" />



<link rel="stylesheet" href="/ego/css/style.css" media="screen" />



<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap" />


<link rel="stylesheet" href="/ego/css/style.css" media="screen" />


  
  <script type=application/javascript>
   var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-40665301-3','auto'),ga('send','pageview'))</script>
  

</head>


  <body>
    <div style="min-height: calc(100vh - 65px)">
      <div class="header-height-fix"></div>
<header class="header-nav">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
          <a class="navbar-brand font-weight-bold mr-0" href="">
            
            <img
              loading="lazy"
              src="/ego/images/logo.png"
              alt="The Organge+"
              height="35px"
            />
            
          </a>

          
          <button
            class="search-toggle d-inline-block d-lg-none ml-auto mr-3"
            data-toggle="search"
            aria-label="Search Toggle"
          >
            <i data-eva="search-outline"></i>
          </button>
          

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navHeader"
            aria-controls="navHeader"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i data-eva="menu-outline"></i>
            <i class="d-none" data-eva="close-outline"></i>
          </button>

          <div class="collapse navbar-collapse" id="navHeader">
            <ul
              class="navbar-nav mx-auto"
            >
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego">Blog</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego/tags">Tags</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego/about">About me</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle d-inline-block "
                  href="#"
                  role="button"
                  data-toggle="dropdown"
                  aria-expanded="false"
                  >More</a
                >
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/categories"
                      >Category</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/elements"
                      >Elements</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/privacy"
                      >Privacy</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/terms-conditions"
                      >Terms & Conditions</a
                    >
                  </li></ul>
              </li>
              
              
              
            </ul>

            
            <div class="navbar-right d-none d-lg-inline-block">
              <ul class="social-links list-unstyled list-inline">
                <li class="list-inline-item ml-4 d-none d-lg-inline-block">
                  <button
                    class="search-toggle"
                    data-toggle="search"
                    aria-label="Search Toggle"
                  >
                    <i data-eva="search-outline"></i>
                  </button>
                </li>
              </ul>
            </div>
            
          </div>
        </nav>
      </div>
    </div>
  </div>
</header>


<div class="search-block">
  <div data-toggle="search-close">
    <i data-eva="close-outline" class="text-primary"></i>
  </div>
  <form action="/search/">
    <input
      id="search-query"
      name="s"
      type="search"
      placeholder="Type words &amp; hit enter"
      class="text-center"
      aria-label="search-query"
    />
  </form>
</div>



      

      <!-- checking blog -->



<section class="section-sm">
  <div class="container">
    <div class="row justify-content-center">
      <div
        class=" col-lg-10 "
      >
        <div class="pr-lg-4">
          <div class="single-post">
            <div class="text-center mb-5">
              <h1 class="mb-4 post-title">Build your own library to render json response in Phoenix</h1>
              <ul class="card-meta list-inline">
                <li class="list-inline-item">
                  <a href="#!" class="card-meta-author"><a href="/ego/author/dung-nguyen" class="card-meta-author">
                      <img
                        loading="lazy"
                        src="/ego/images/author/dung-nguyen.jpg"
                        alt="Dung Nguyen"
                      />
                      <span>Dung Nguyen</span>
                    </a>
                  </a>
                </li>
                <li class="list-inline-item">|</li>
                <li class="list-inline-item">
                  <span>2021-07-23</span>
                </li>
              </ul>
            </div>

            
            <div class="mb-5 text-center">
              <img
                loading="lazy"
                class="img-fluid rounded"
                src="/ego/img/build-a-json-view.png"
                alt="Image not Found"
              />
            </div>
            

            <div class="content"><p>In my previous article, I introduced my library call <code class="inline">JsonView</code> to render json response easier. You can read it here:
<a href="/blog/2021-07-10-render-response-json-view">Render Ecto schema to json with relationships with JsonView</a></p><p>Today I will guide you to write your own Json render view. Let's start.</p><p>Now for example I have a Blog app with <code class="inline">User</code> <code class="inline">Category</code> , <code class="inline">Post</code> and <code class="inline">Comment</code> schemas.</p><p>This is <code class="inline">PostView</code> which is generated by <code class="inline">Phoenix</code></p><pre><code class="elixir">defmodule MyBlogWeb.PostView do
  use MyBlogWeb, :view
  alias MyBlogWeb.PostView

  def render("index.json", %{posts: posts}) do
    %{data: render_many(posts, PostView, "post.json")}
  end

  def render("show.json", %{post: post}) do
    %{data: render_one(post, PostView, "post.json")}
  end

  def render("post.json", %{post: post}) do
    %{id: post.id,
      title: post.title,
      description: post.description,
      content: post.content,
      cover: post.cover,
      is_published: post.is_published}
  end
end
</code></pre><p><strong>Let's improve it</strong></p><h3 id="1-use-map-take">1. Use <code class="inline">Map.take</code></h3><pre><code class="elixir">...
def render("post.json", %{post: post}) do
        Map.take(post, [:id, :title, :description, :content, :cover, :is_published])
end
...</code></pre><p>This way you don't have to write much code every time you add a new attribute.</p><h3 id="2-render-custom-field">2. Render custom field</h3><p>You may want to:</p><ul><li>Format some field value instead of return original value</li><li>Calculate virtual field</li></ul><p>Normally you will do this:</p><pre><code class="elixir">    def render("post.json", %{post: post}) do
    post
    |> Map.take([:id, :title, :description, :content, :cover, :is_published])
    |> Map.merge(%{
      comment_count: render_comment_count(post),
      author_name: render_author_name(post)
    })
  end

  def render_comment_count(post) do
    ...
  end

  def render_author_name(post) do
    ...
  end</code></pre><p>Or you can reduce a bit of code by using pattern matching to render custom field value</p><pre><code class="elixir">    def render("post.json", %{post: post}) do
    post
    |> Map.take([:id, :title, :description, :content, :cover, :is_published])
    |> Map.merge(render_custom_fields(post, [:comment_count, :author_name]))
  end

  defp render_custom_fields(struct, fields) do
    Enum.map(fields, fn field ->
        {field, render_field(field, struct)}
    end)
    |> Enum.into(%{})
  end

  defp render_field(:comment_count, post) do
    ...
  end

  defp render_field(:author_name, post) do
    ...
  end</code></pre><p>Now every time you add a new custom field, just add field name to the list, and define a <code class="inline">render_field/2</code> function</p><h3 id="3-render-relation-ship">3. Render relation ship</h3><p>You may want to return the whole object of author. For example you have a view <code class="inline">UserView</code> so you can do:</p><pre><code class="elixir"> def render("post.json", %{post: post}) do
    post
    ...
    |> Map.merge(%{
      author: render_one(post.author, MyBlogWeb.UserView, "user.json")
    })
 end</code></pre><p>It requires that author must be loaded, if not, you will get this error</p><pre><code>** (KeyError) key :id not found in: #Ecto.Association.NotLoaded<association :author is not loaded></code></pre><p>You can handle it by pattern matching against <code class="inline">Ecto.Association.NotLoaded</code></p><pre><code class="elixir"> def render("post.json", %{post: post}) do
    post
    ...
    |> Map.merge(%{
      author: render_relationship(post.author, MyBlogWeb.UserView, "user.json")
    })
 end
 
 defp render_relationship(%Ecto.Association.NotLoaded{}, _, _), do: nil
 
 defp render_relationship(relation, view, template) do
    render_one(relation, view, template)
 end</code></pre><p>And it only render relations struct if loaded, otherwise it is set to nil.</p><p>Now you can improve it to render list of relationships</p><pre><code class="elixir">def render("post.json", %{post: post}) do
    post
    ...
    |> Map.merge(
      render_relationship(post, [
        {:author, MyBlogWeb.UserView, "user.json"},
        {:comments, MyBlogWeb.CommentView, "comment.json"}
      ])
    )
end

defp render_relationship(struct, relationships) do
    Enum.map(relationships, fn {field, view, template} ->
      {field, render_relationship(Map.get(struct, field), view, template)}
    end)
    |> Enum.into(%{})
end

defp render_relationship(%Ecto.Association.NotLoaded{}, _, _), do: nil

defp render_relationship(relations, view, template) when is_list(relations) do
    render_many(relations, view, template)
end

defp render_relationship(relation, view, template) do
    render_one(relation, view, template)
end</code></pre><p>With this way you can handle both single struct and list of struct.</p><h3 id="4-combines-these-helper-functions">4. Combines these helper functions</h3><p>You can combine them all in one function and only need to pass field definition to this function</p><pre><code class="elixir">@fields [:id, :title, :description, :content, :cover, :is_published]
  @custom_fiels [:comment_count, :author_name]
  @relationships [
    {:author, MyBlogWeb.UserView, "user.json"},
    {:comments, MyBlogWeb.CommentView, "comment.json"}
  ]

  def render("post.json", %{post: post}) do
    render_json(post, @fields, @custom_fiels, @relationships)
  end

  def render_json(struct, fields, custom_fields \\ [], relationships \\ []) do
    struct
    |> Map.take(fields)
    |> Map.merge(render_custom_fields(struct, custom_fields))
    |> Map.merge(render_relationship(struct, relationships))
  end</code></pre><h2 id="move-them-to-a-helper">Move them to a helper</h2><p>These functions are the same for every view, so let's move these code to a helper module <code class="inline">JsonViewHelper</code></p><pre><code class="elixir">defmodule JsonViewHelper do
  import Phoenix.View, only: [render_one: 3, render_many: 3]

  def render_json(struct, view, fields, custom_fields \\ [], relationships \\ []) do
    struct
    |> Map.take(fields)
    |> Map.merge(render_custom_fields(struct, view, custom_fields))
    |> Map.merge(render_relationship(struct, relationships))
  end

  defp render_custom_fields(struct, view, fields) do
    Enum.map(fields, fn field ->
      {field, view.render_field(field, struct)}
    end)
    |> Enum.into(%{})
  end

  defp render_relationship(struct, relationships) do
    Enum.map(relationships, fn {field, view, template} ->
      {field, render_relationship(Map.get(struct, field), view, template)}
    end)
    |> Enum.into(%{})
  end

  defp render_relationship(%Ecto.Association.NotLoaded{}, _, _), do: nil

  defp render_relationship(relations, view, template) when is_list(relations) do
    render_many(relations, view, template)
  end

  defp render_relationship(relation, view, template) do
    render_one(relation, view, template)
  end
end</code></pre><p>Here I modify <code class="inline">render_custom_fields</code> a bit, because we call <code class="inline">render_field</code> to render custom field, so we have pass the view module as second parameter, so we can use the module to invoke those <code class="inline">render_field</code> that we define.</p><p>And now render json response is much simple:</p><pre><code class="elixir">defmodule BlogeeWeb.PostView do
    ...
  @fields [:id, :title, :description, :content, :cover]
  @custom_fields [:status]
  @relationships [
    {:author, BlogeeWeb.UserView, "basic_info.json"},
    {:category, BlogeeWeb.CategoryView, "category.json"}
  ]
  def render("post.json", %{post: post}) do
    JsonViewHelper.render_json(post, __MODULE__, @fields, @custom_fields, @relationships)
  end

  def render_field(:status, post) do
    if post.is_published do
      "published"
    else
      "draft"
    end
  end
end</code></pre><h2 id="hooray">Hooray</h2><p>Thank you for reading to the end of this article. Hope that this can help.
If you want to use render hook, take a look at my github for full code</p><p><a href="https://github.com/bluzky/json_view">https://github.com/bluzky/json_view</a></p></div>
          </div>

          <!-- Post meta -->
          <div class="single-post-meta">
            <div class="row justify-content-center">
              <div class="col-md-6 text-center text-md-left">
                <ul class="post-meta-tags list-unstyled list-inline">
                  
                  <li class="list-inline-item">
                    <a href="/ego/tagselixir">#elixir</a>
                  </li>
                  
                  <li class="list-inline-item">
                    <a href="/ego/tagsphoenix">#phoenix</a>
                  </li>
                  
                  <li class="list-inline-item">
                    <a href="/ego/tagsjson-view">#json view</a>
                  </li>
                  
                </ul>
              </div>
              <div class="col-md-6 text-center text-md-right mt-4 mt-md-0">
<ul
  class="social-links has-bg-color list-unstyled list-inline"
  style="line-height: 0"
>
  <li class="list-inline-item">
    <!-- Sharingbutton Facebook -->
    <a
      class="resp-sharing-button__link d-block"
      href="https://facebook.com/sharer/sharer.php?u=/ego/blog/2021-07-23-build-a-json-view-yourself"
      target="_blank"
      rel="noopener"
      aria-label=""
    >
      <div
        class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"
      >
        <div
          aria-hidden="true"
          class="resp-sharing-button__icon resp-sharing-button__icon--solid"
        >
          <i data-eva="facebook-outline" class="text-dark"></i>
        </div>
      </div>
    </a>
  </li>

  <li class="list-inline-item">
    <!-- Sharingbutton Twitter -->
    <a
      class="resp-sharing-button__link d-block"
      href="https://twitter.com/intent/tweet/?text=Build your own library to render json response in Phoenix&amp;url=/ego/blog/2021-07-23-build-a-json-view-yourself"
      target="_blank"
      rel="noopener"
      aria-label=""
    >
      <div
        class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"
      >
        <div
          aria-hidden="true"
          class="resp-sharing-button__icon resp-sharing-button__icon--solid"
        >
          <i data-eva="twitter-outline" class="text-dark"></i>
        </div>
      </div>
    </a>
  </li>
</ul>
</div>
            </div>
          </div>

          <div class="single-post-author">
            <div class="row justify-content-center">
              <div class="col-md-12">
                <div class="media d-block d-sm-flex text-center text-sm-left">
                  <a href="/ego/author/dung-nguyen"
                    ><img
                      loading="lazy"
                      class="img-fluid rounded-circle mr-0 mr-sm-4 mb-4"
                      src="/ego/images/author/dung-nguyen.jpg"
                      alt="Dung Nguyen"
                  /></a>
                  <div class="media-body">
                    <h4>
                      <a href="/ego/author/dung-nguyen" class="text-dark font-weight-700"
                        >Dung Nguyen</a
                      >
                    </h4>
                    <p class="font-primary"><p>Hi! I'm Dung Nguyen. I'm an Elixir developer at OnPoint Vietnam.</p></p>
                    <ul
                      class="social-links list-unstyled list-inline ml-0 ml-sm-n2"
                    >
                      
                      <li class="list-inline-item">
                        <a href="https://www.linkedin.com/in/dung-nguyen-tien-695ba135/">
                          <i class="lab linkedin-outline"></i>
                        </a>
                      </li>
                      
                      <li class="list-inline-item">
                        <a href="https://www.github.com/bluzky">
                          <i class="lab github-outline"></i>
                        </a>
                      </li>
                      
                      <li class="list-inline-item">
                        <a href="https://dev.to/bluzky">
                          <i class="lab book-outline"></i>
                        </a>
                      </li>
                      
                    </ul>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

          <!-- DISQUS comment -->
          
          <div class="single-post-similer">
            <div class="row justify-content-center">
              <div class="col-md-12">
                <div class="row mt-3">
                  <div id="disqus_thread" class="w-100"></div>
                </div>
              </div>
            </div>
          </div>
          

          <div class="single-post-similer">
            <div class="row justify-content-center">
              <div class="col-md-12">
                <div class="row mt-3">
                  <div class="col-12">
                    <h3 class="text-dark font-weight-800 mb-4 pb-2">
                      You May Also Like
                    </h3>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>
  </div>
</section>



    </div>
    <footer class="section-sm p-0">
  <div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-lg-5">
         
      </div>
      <div class="col-lg-12 text-center mb-3">
        
        <ul
          class="social-links icon-box list-unstyled list-inline font-weight-500 mb-3"
        >
          
        </ul>

        <p class="mb-0 font-weight-500 copyright-text content">
          <p>
Blog by Dung Nguyen.Theme by <a href="https://gethugothemes.com/">Gethugothemes</a></p>

        </p>
      </div>
    </div>
  </div>
</footer>

    <!-- JS Plugins + Main script -->


<script data-turbolinks-suppress-warning src="/ego/plugins/jquery/jquery.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/bootstrap/bootstrap.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/fuse.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/mark.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/search.js"></script>
 

<script src="https://unpkg.com/eva-icons"></script>
 

<script
  data-turbolinks-suppress-warning
  src="/ego/js/script.js"
></script>

<!-- cookie -->


<!-- DISQUS -->

<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
  */
  (function () {
    // DON'T EDIT BELOW THIS LINE
    var d = document,
      s = d.createElement("script");
    s.src = "https://.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>


  </body>
</html>
