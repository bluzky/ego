<!DOCTYPE html>
<html lang="en-US">
  <head>
  <meta charset="utf-8" />
  <title>The Organge+</title>

  <meta name="author" content="Dung Nguyen" />
  <meta
    name="description"
    content=""
  />

  <!-- mobile responsive meta -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
  />

  <!-- Favicon -->
  <link
    rel="icon"
    href="/ego/images/favicon.png"
    type="image/x-icon"
  />

  <!-- CSS Plugins -->
  <!-- plugins + stylesheet -->
<link rel="preconnect" href="https://fonts.gstatic.com" />
 
<link rel="stylesheet" href="/ego/plugins/bootstrap/bootstrap.min.css" media="screen" />
  
<link rel="stylesheet" href="/ego/css/style.css" media="screen" />
  
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap" />
 


  
  <script type=application/javascript>
   var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-40665301-3','auto'),ga('send','pageview'))</script>
  

</head>


  <body>
    <div style="min-height: calc(100vh - 65px)">
      <div class="header-height-fix"></div>
<header class="header-nav">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
          <a class="navbar-brand font-weight-bold mr-0" href="">
            
            <img
              loading="lazy"
              src="/ego/images/logo.png"
              alt="The Organge+"
              height="35px"
            />
            
          </a>

          
          <button
            class="search-toggle d-inline-block d-lg-none ml-auto mr-3"
            data-toggle="search"
            aria-label="Search Toggle"
          >
            <i data-eva="search-outline"></i>
          </button>
          

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navHeader"
            aria-controls="navHeader"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i data-eva="menu-outline"></i>
            <i class="d-none" data-eva="close-outline"></i>
          </button>

          <div class="collapse navbar-collapse" id="navHeader">
            <ul
              class="navbar-nav mx-auto"
            >
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego">Blog</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego/tags">Tags</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/ego/about">About me</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle d-inline-block "
                  href="#"
                  role="button"
                  data-toggle="dropdown"
                  aria-expanded="false"
                  >More</a
                >
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/categories"
                      >Category</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/elements"
                      >Elements</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/privacy"
                      >Privacy</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/ego/terms-conditions"
                      >Terms & Conditions</a
                    >
                  </li></ul>
              </li>
              
              
              
            </ul>

            
            <div class="navbar-right d-none d-lg-inline-block">
              <ul class="social-links list-unstyled list-inline">
                <li class="list-inline-item ml-4 d-none d-lg-inline-block">
                  <button
                    class="search-toggle"
                    data-toggle="search"
                    aria-label="Search Toggle"
                  >
                    <i data-eva="search-outline"></i>
                  </button>
                </li>
              </ul>
            </div>
            
          </div>
        </nav>
      </div>
    </div>
  </div>
</header>


<div class="search-block">
  <div data-toggle="search-close">
    <i data-eva="close-outline" class="text-primary"></i>
  </div>
  <form action="/search/">
    <input
      id="search-query"
      name="s"
      type="search"
      placeholder="Type words &amp; hit enter"
      class="text-center"
      aria-label="search-query"
    />
  </form>
</div>



      

      <!-- checking blog -->



<section class="section-sm">
  <div class="container">
    <div class="row justify-content-center">
      <div
        class=" col-lg-10 "
      >
        <div class="pr-lg-4">
          <div class="single-post">
            <div class="text-center mb-5">
              <h1 class="mb-4 post-title">Encrypt your database with Ecto custom type</h1>
              <ul class="card-meta list-inline">
                <li class="list-inline-item">
                  <a href="#!" class="card-meta-author"><a href="/ego/author/dung-nguyen" class="card-meta-author">
                      <img
                        loading="lazy"
                        src="/ego/images/author/dung-nguyen.jpg"
                        alt="Dung Nguyen"
                      />
                      <span>Dung Nguyen</span>
                    </a>
                  </a>
                </li>
                <li class="list-inline-item">|</li>
                <li class="list-inline-item">
                  <span>2021-08-20</span>
                </li>
              </ul>
            </div>

            
            <div class="mb-5 text-center">
              <img
                loading="lazy"
                class="img-fluid rounded"
                src="/ego/img/encrypt-data-ecto.png"
                alt="Image not Found"
              />
            </div>
            

            <div class="content"><p>
If your data is encrypted, even if it’s leaked, no one know what is the data. That’s great.</p>
<p>
In this post, I’m going to show you how to encrypt data with Ecto. <code class="inline">Ecto</code> allows developer to define their own types. And we will define a type called <code class="inline">EncryptedText</code> which encrypts data before persiting to database and decrypts data after loading.</p>
<h2>
1. Define encrypt/decrypt methods</h2>
<p>
This is a simple version of crypto module:</p>
<pre><code class="elixir">defmodule Crypto do
  @block_size 16

  def generate_secret do
    :crypto.strong_rand_bytes(@block_size)
    |&gt; Base.encode64()
  end

  def encrypt(plaintext, secret_key) do
    with {:ok, secret_key} &lt;- decode_key(secret_key) do
      iv = :crypto.strong_rand_bytes(@block_size)
      plaintext = pad(plaintext, @block_size)
      ciphertext = :crypto.crypto_one_time(:aes_128_cbc, secret_key, iv, plaintext, true)

      {:ok, Base.encode64(iv &lt;&gt; ciphertext)}
    end
  end

  def decrypt(ciphertext, secret_key) do
    with {:ok, secret_key} &lt;- decode_key(secret_key),
         {:ok, &lt;&lt;iv::binary-@block_size, ciphertext::binary&gt;&gt;} &lt;- Base.decode64(ciphertext) do
      plaintext =
        :crypto.crypto_one_time(:aes_128_cbc, secret_key, iv, ciphertext, false)
        |&gt; unpad

      {:ok, plaintext}
    else
      {:error, _} = err -&gt; err
      _ -&gt; {:error, &quot;Bad encrypted data&quot;}
    end
  end

  defp pad(data, block_size) do
    to_add = block_size - rem(byte_size(data), block_size)
    data &lt;&gt; :binary.copy(&lt;&lt;to_add&gt;&gt;, to_add)
  end

  defp unpad(data) do
    to_remove = :binary.last(data)
    :binary.part(data, 0, byte_size(data) - to_remove)
  end
end</code></pre>
<p>
Let go through the code</p>
<pre><code class="elixir">  def generate_secret do
    :crypto.strong_rand_bytes(@block_size)
    |&gt; Base.encode64()
  end</code></pre>
<p>
This function generate a 16 bytes secret key and encode base 64 string so you can add it to config.</p>
<ul>
  <li>
<code class="inline">encrypt/2</code> function  </li>
</ul>
<pre><code class="elixir"> def encrypt(plaintext, secret_key) do
    # check the key size
    with {:ok, secret_key} &lt;- decode_key(secret_key) do
      
      # random initial vector
      iv = :crypto.strong_rand_bytes(@block_size)
      # if length of text is not multiple of @block_size
      # we add more data until it meets condition
      plaintext = pad(plaintext, @block_size)
      # encrypt here
      ciphertext = :crypto.crypto_one_time(:aes_128_cbc, secret_key, iv, plaintext, true)

      {:ok, Base.encode64(iv &lt;&gt; ciphertext)}
    end
  end</code></pre>
<p>
This is the most important line</p>
<pre><code class="elixir">ciphertext = :crypto.crypto_one_time(:aes_128_cbc, secret_key, iv, plaintext, true)</code></pre>
<ul>
  <li>
<code class="inline">iv</code> is initial vector. AES-128 algorithms encrypts data by block of 16 bytes, so we need initial vector to make sure that the output of blocks with same data are different from each other.  </li>
  <li>
The last parameter is set to <code class="inline">true</code> to encrypt, set to <code class="inline">false</code> to decrypt data  </li>
</ul>
<p>
And then we encode output to base 64 string. Here we concatenate <code class="inline">iv</code> and <code class="inline">ciphertext</code> so that we can extract <code class="inline">iv</code> to use for decrypting</p>
<pre><code class="elixir">{:ok, Base.encode64(iv &lt;&gt; ciphertext)}</code></pre>
<ul>
  <li>
<code class="inline">decrypt/2</code> function  </li>
</ul>
<pre><code class="elixir">def decrypt(ciphertext, secret_key) do
    # check the key
    with {:ok, secret_key} &lt;- decode_key(secret_key),
         {:ok, &lt;&lt;iv::binary-@block_size, ciphertext::binary&gt;&gt;} &lt;- Base.decode64(ciphertext) do
      plaintext =
        :crypto.crypto_one_time(:aes_128_cbc, secret_key, iv, ciphertext, false)
        |&gt; unpad

      {:ok, plaintext}
    else
      {:error, _} = err -&gt; err
      _ -&gt; {:error, &quot;Bad encrypted data&quot;}
    end
  end</code></pre>
<p>
We extract <code class="inline">iv</code> and encrypted data from input</p>
<pre><code class="elixir">{:ok, &lt;&lt;iv::binary-@block_size, ciphertext::binary&gt;&gt;} &lt;- Base.decode64(ciphertext)</code></pre>
<p>
We use pattern matching to extract first 16 byte and assign to <code class="inline">iv</code> and assign remaining data to <code class="inline">ciphertext</code>. Then decrypting data</p>
<pre><code class="elixir">plaintext =
    :crypto.crypto_one_time(:aes_128_cbc, secret_key, iv, ciphertext, false)
    |&gt; unpad</code></pre>
<p>
This line is similar to the line which encrypts data, the difference is here we replace <code class="inline">plaintext</code> by <code class="inline">ciphertext</code> and last parameter is set to <code class="inline">false</code>. After data is decrypted, we need to remove padding to get the original data.</p>
<h2>
2. Build <code class="inline">EncryptedText</code> type</h2>
<p>
I define a type to store binary data, you can define a <code class="inline">EncryptedMap</code> to store map data. The most important function are <code class="inline">dump</code> and <code class="inline">load</code> where we encrypt before persisting and decrypt after loading.</p>
<pre><code class="elixir">defmodule EncryptedText do
  use Ecto.Type

  # we store data as string
  def type, do: :string

  def cast(value) when is_binary(value) do
    {:ok, value}
  end
  def cast(_), do: :error

  def dump(nil), do: nil
  # encrypt data before persist to database
  def dump(data) when is_binary(data) do
    with {:ok, secret_key} &lt;- Application.fetch_env(:myapp, :ecto_secret_key),
         {:ok, data} &lt;- Crypto.encrypt(data, secret_key) do
      {:ok, data}
    else
      _ -&gt; :error
    end
  end

  def dump(_), do: :error

  def load(nil), do: nil
  # decrypt data after loaded from database
  def load(data) when is_binary(data) do
    secret_key = Application.fetch_env!(:myapp, :ecto_secret_key)
    case Crypto.decrypt(data, secret_key) do
      {:error, _} -&gt; :error
      ok -&gt; ok
    end
  end

  def load(_), do: :error

  def embed_as(_), do: :dump
end
</code></pre>
<h2>
3. Use it in your schema</h2>
<ul>
  <li>
You must add secret key to your app config first.  </li>
</ul>
<pre><code class="elixir">config :myapp, :ecto_secret_key, &quot;your key using Crypto.generate_secret&quot;</code></pre>
<ul>
  <li>
Add to schema  </li>
</ul>
<pre><code class="elixir">schema &quot;users&quot; do
    field :name, :string
    ...
    field :secret, EncryptedText
    ...
end</code></pre>
<p>
Your data are safe now.</p>
<h2>
4. Conclusion</h2>
<p>
With Crypto you can implement encrypted field for any type of data you want.</p>
<p>
There is an issue when you want to change your secret key, you have to load your data row by row, decrypt and then encrypt with new key and update to database.</p>
<p>
I found this article which explains very well about crypto if you are interested <a href="https://www.thegreatcodeadventure.com/elixir-encryption-with-erlang-crypto/">https://www.thegreatcodeadventure.com/elixir-encryption-with-erlang-crypto/</a>
Although she uses old crypto API so it will throw some warnings.</p>
<p>
I implemented encrypted type for text and map for my company project here if you want to use it: </p>
<p>
<a href="https://github.com/onpointvn/magik/tree/main/lib/ecto_type">Github</a></p>
<p>
Thanks for reading.</p>
</div>
          </div>

          <!-- Post meta -->
          <div class="single-post-meta">
            <div class="row justify-content-center">
              <div class="col-md-6 text-center text-md-left">
                <ul class="post-meta-tags list-unstyled list-inline">
                  
                  <li class="list-inline-item">
                    <a href="/ego/tagselixir">#elixir</a>
                  </li>
                  
                  <li class="list-inline-item">
                    <a href="/ego/tagsecto">#ecto</a>
                  </li>
                  
                  <li class="list-inline-item">
                    <a href="/ego/tagscrypto">#crypto</a>
                  </li>
                  
                </ul>
              </div>
              <div class="col-md-6 text-center text-md-right mt-4 mt-md-0">
<ul
  class="social-links has-bg-color list-unstyled list-inline"
  style="line-height: 0"
>
  <li class="list-inline-item">
    <!-- Sharingbutton Facebook -->
    <a
      class="resp-sharing-button__link d-block"
      href="https://facebook.com/sharer/sharer.php?u=/ego/blog/2021-08-20-encrypt-data-with-ecto"
      target="_blank"
      rel="noopener"
      aria-label=""
    >
      <div
        class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"
      >
        <div
          aria-hidden="true"
          class="resp-sharing-button__icon resp-sharing-button__icon--solid"
        >
          <i data-eva="facebook-outline" class="text-dark"></i>
        </div>
      </div>
    </a>
  </li>

  <li class="list-inline-item">
    <!-- Sharingbutton Twitter -->
    <a
      class="resp-sharing-button__link d-block"
      href="https://twitter.com/intent/tweet/?text=Encrypt your database with Ecto custom type&amp;url=/ego/blog/2021-08-20-encrypt-data-with-ecto"
      target="_blank"
      rel="noopener"
      aria-label=""
    >
      <div
        class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"
      >
        <div
          aria-hidden="true"
          class="resp-sharing-button__icon resp-sharing-button__icon--solid"
        >
          <i data-eva="twitter-outline" class="text-dark"></i>
        </div>
      </div>
    </a>
  </li>
</ul>
</div>
            </div>
          </div>

          <div class="single-post-author">
            <div class="row justify-content-center">
              <div class="col-md-12">
                <div class="media d-block d-sm-flex text-center text-sm-left">
                  <a href="/ego/author/dung-nguyen"
                    ><img
                      loading="lazy"
                      class="img-fluid rounded-circle mr-0 mr-sm-4 mb-4"
                      src="/ego/images/author/dung-nguyen.jpg"
                      alt="Dung Nguyen"
                  /></a>
                  <div class="media-body">
                    <h4>
                      <a href="/ego/author/dung-nguyen" class="text-dark font-weight-700"
                        >Dung Nguyen</a
                      >
                    </h4>
                    <p class="font-primary"><p>
Hi! I’m Dung Nguyen. I’m an Elixir developer at OnPoint Vietnam.</p>
</p>
                    <ul
                      class="social-links list-unstyled list-inline ml-0 ml-sm-n2"
                    >
                      
                      <li class="list-inline-item">
                        <a href="https://www.linkedin.com/in/dung-nguyen-tien-695ba135/">
                          <i class="lab linkedin-outline"></i>
                        </a>
                      </li>
                      
                      <li class="list-inline-item">
                        <a href="https://www.github.com/bluzky">
                          <i class="lab github-outline"></i>
                        </a>
                      </li>
                      
                      <li class="list-inline-item">
                        <a href="https://dev.to/bluzky">
                          <i class="lab book-outline"></i>
                        </a>
                      </li>
                      
                    </ul>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

          <!-- DISQUS comment -->
          
          <div class="single-post-similer">
            <div class="row justify-content-center">
              <div class="col-md-12">
                <div class="row mt-3">
                  <div id="disqus_thread" class="w-100"></div>
                </div>
              </div>
            </div>
          </div>
          

          <div class="single-post-similer">
            <div class="row justify-content-center">
              <div class="col-md-12">
                <div class="row mt-3">
                  <div class="col-12">
                    <h3 class="text-dark font-weight-800 mb-4 pb-2">
                      You May Also Like
                    </h3>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>
  </div>
</section>



    </div>
    <footer class="section-sm p-0">
  <div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-lg-5">
         
      </div>
      <div class="col-lg-12 text-center mb-3">
        
        <ul
          class="social-links icon-box list-unstyled list-inline font-weight-500 mb-3"
        >
          
        </ul>

        <p class="mb-0 font-weight-500 copyright-text content">
          <p>
Blog by Dung Nguyen.Theme by <a href="https://gethugothemes.com/">Gethugothemes</a></p>

        </p>
      </div>
    </div>
  </div>
</footer>

    <!-- JS Plugins + Main script -->


<script data-turbolinks-suppress-warning src="/ego/plugins/jquery/jquery.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/bootstrap/bootstrap.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/fuse.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/mark.js"></script>
 

<script data-turbolinks-suppress-warning src="/ego/plugins/search/search.js"></script>
 

<script src="https://unpkg.com/eva-icons"></script>
 

<script
  data-turbolinks-suppress-warning
  src="/ego/js/script.js"
></script>

<!-- cookie -->


<!-- DISQUS -->

<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
  */
  (function () {
    // DON'T EDIT BELOW THIS LINE
    var d = document,
      s = d.createElement("script");
    s.src = "https://.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>


  </body>
</html>
